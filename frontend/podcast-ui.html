<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amplify - Real-Time Podcast Fact Checker</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background: #FFFFFF;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        .main-container {
            width: 100%;
            max-width: 1440px;
            height: 1024px;
            margin: 0 auto;
            position: relative;
            background: #FFF;
        }

        /* Amplify Logo */
        .logo {
            position: absolute;
            left: 10px;
            top: 64px;
            width: 200px;
            height: 113px;
            z-index: 10;
        }

        .logo-text {
            font-size: 48px;
            font-weight: 700;
            color: #2D571A;
            line-height: 1;
        }

        .logo-subtitle {
            font-size: 14px;
            font-weight: 400;
            color: #448127;
            margin-top: -5px;
        }

        /* Topic Timeline Section */
        .timeline-container {
            position: absolute;
            left: 214px;
            top: 11px;
            width: 1207px;
            height: 231px;
            background: rgba(243, 249, 239, 0.90);
            border-radius: 40px;
            padding: 27px 20px 15px 20px;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .timeline-title {
            color: #2D571A;
            font-size: 24px;
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-family: 'Fredoka', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-start {
            background: #448127;
            color: white;
        }

        .btn-start:hover:not(:disabled) {
            background: #2D571A;
        }

        .btn-stop {
            background: #C43030;
            color: white;
        }

        .btn-stop:hover:not(:disabled) {
            background: #8F0A0A;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .timeline-divider {
            width: 1159px;
            height: 1px;
            background: #B1B1B1;
            margin-bottom: 15px;
        }

        .timeline-scroll {
            height: 120px;
            overflow-x: auto;
            overflow-y: hidden;
            margin-bottom: 15px;
        }

        .timeline-scroll::-webkit-scrollbar {
            height: 6px;
        }

        .timeline-scroll::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .timeline-scroll::-webkit-scrollbar-thumb {
            background: #2D571A;
            border-radius: 3px;
        }

        .timeline-flow {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: min-content;
            padding: 10px 0;
        }

        .topic-badge {
            background: #2D571A;
            color: #FFF;
            font-size: 20px;
            font-weight: 400;
            padding: 10px 20px;
            border-radius: 12px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            min-width: 142px;
            text-align: center;
        }

        .topic-badge:hover {
            transform: scale(1.05);
        }

        .topic-badge.active {
            background: #448127;
            box-shadow: 0 0 10px rgba(68, 129, 39, 0.4);
        }

        .topic-timestamp {
            font-size: 14px;
            color: #8F0A0A;
            margin-top: 5px;
            text-align: center;
        }

        .topic-arrow {
            color: #B1B1B1;
            font-size: 20px;
            flex-shrink: 0;
        }

        /* Progress Bar */
        .progress-container {
            width: 1160px;
            height: 14px;
            background: #D9D9D9;
            border-radius: 11px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #A5A5A5;
            border: 1px solid rgba(0, 0, 0, 0.19);
            border-radius: 11px;
            transition: width 0.5s ease;
            width: 0%;
        }

        /* Media Section */
        .media-container {
            position: absolute;
            left: 0;
            top: 261px;
            width: 539px;
            height: 427px;
            background: rgba(243, 249, 239, 0.90);
            border-radius: 41px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
        }

        .media-placeholder {
            color: #2D571A;
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            line-height: 1.3;
        }

        .media-image {
            max-width: 100%;
            max-height: 320px;
            border-radius: 20px;
            object-fit: contain;
            display: none;
        }

        .media-image.visible {
            display: block;
        }

        .media-topic {
            margin-top: 15px;
            color: #2D571A;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }

        /* Fact-Check Section */
        .factcheck-container {
            position: absolute;
            left: 559px;
            top: 261px;
            width: 850px;
            height: 642px;
            background: rgba(243, 249, 239, 0.90);
            border-radius: 41px;
            padding: 25px;
        }

        .factcheck-header {
            color: #2D571A;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #B1B1B1;
        }

        .factcheck-stats {
            display: flex;
            gap: 25px;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 10px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }

        .stat-dot {
            width: 19px;
            height: 19px;
            border-radius: 50%;
        }

        .stat-dot.supported {
            background: #448127;
        }

        .stat-dot.uncertain {
            background: rgba(204, 186, 55, 0.93);
        }

        .stat-dot.contradicted {
            background: #C43030;
            border: 1px solid rgba(143, 10, 10, 0.7);
        }

        .factcheck-scroll {
            height: 480px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .factcheck-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .factcheck-scroll::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .factcheck-scroll::-webkit-scrollbar-thumb {
            background: #2D571A;
            border-radius: 3px;
        }

        .fact-item {
            border-radius: 33px;
            padding: 20px;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }

        .fact-item:hover {
            transform: translateX(3px);
        }

        .fact-item.supported {
            background: rgba(68, 129, 39, 0.20);
        }

        .fact-item.uncertain {
            background: rgba(204, 186, 55, 0.20);
        }

        .fact-item.contradicted {
            background: rgba(196, 48, 48, 0.20);
        }

        .fact-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .verdict-dot {
            width: 19px;
            height: 19px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .verdict-dot.supported {
            background: #448127;
        }

        .verdict-dot.uncertain {
            background: rgba(204, 186, 55, 0.93);
        }

        .verdict-dot.contradicted {
            background: #C43030;
            border: 1px solid rgba(143, 10, 10, 0.7);
        }

        .verdict-label {
            font-size: 24px;
            font-weight: 400;
        }

        .fact-claim {
            font-size: 24px;
            font-weight: 400;
            line-height: 1.2;
            margin-bottom: 5px;
        }

        .fact-timestamp {
            color: #448127;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .fact-source {
            font-size: 24px;
            font-weight: 400;
            margin-top: 5px;
        }

        .fact-source a {
            color: #2C497F;
            text-decoration: underline;
            cursor: pointer;
        }

        .fact-expand {
            color: rgba(0, 0, 0, 0.46);
            font-size: 15px;
            margin-top: 8px;
            cursor: pointer;
        }

        .expand-badge {
            display: inline-block;
            background: rgba(44, 73, 127, 0.17);
            border-radius: 9px;
            padding: 3px 10px;
            margin-top: 5px;
        }

        .expand-arrow {
            color: #2C497F;
            margin-left: 5px;
        }

        /* Episode Section */
        .episode-container {
            position: absolute;
            left: 10px;
            top: 869px;
            width: 547px;
            height: 116px;
            background: rgba(243, 249, 239, 0.90);
            border-radius: 41px;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .episode-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .episode-title {
            font-size: 24px;
            font-weight: 400;
        }

        .episode-number {
            color: #448127;
            font-weight: 700;
        }

        .episode-time {
            color: #448127;
            font-size: 15px;
            font-weight: 700;
        }

        .waveform {
            display: none;
            gap: 4px;
            align-items: center;
        }

        .waveform.active {
            display: flex;
        }

        .wave-bar {
            width: 5px;
            background: #448127;
            border-radius: 10px;
            animation: wave 1s ease-in-out infinite;
        }

        .wave-bar:nth-child(1) { animation-delay: 0s; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes wave {
            0%, 100% { height: 20px; }
            50% { height: 35px; }
        }

        .no-data {
            text-align: center;
            color: rgba(0, 0, 0, 0.3);
            padding: 40px;
            font-size: 18px;
        }

        .loading {
            text-align: center;
            color: #2D571A;
            padding: 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Logo -->
        <div class="logo">
            <div class="logo-text">AMPLIFY</div>
            <div class="logo-subtitle">Real-Time Fact Checking</div>
        </div>

        <!-- Topic Timeline -->
        <div class="timeline-container">
            <div class="timeline-header">
                <div class="timeline-title">TOPIC TIMELINE</div>
                <div class="controls">
                    <button class="btn btn-start" id="startBtn" onclick="startStream()">Start</button>
                    <button class="btn btn-stop" id="stopBtn" onclick="stopStream()" disabled>Stop</button>
                </div>
            </div>
            <div class="timeline-divider"></div>
            <div class="timeline-scroll">
                <div class="timeline-flow" id="timelineFlow">
                    <div class="loading">Click Start to begin...</div>
                </div>
            </div>
            <div class="progress-container">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <!-- Media Section -->
        <div class="media-container">
            <div class="media-placeholder" id="mediaPlaceholder">&lt;MEDIA<br>PLACEHOLDER&gt;</div>
            <img class="media-image" id="mediaImage" alt="Topic Image">
            <div class="media-topic" id="mediaTopic"></div>
        </div>

        <!-- Fact-Check Section -->
        <div class="factcheck-container">
            <div class="factcheck-header">FACT-CHECK</div>
            <div class="factcheck-stats">
                <div class="stat-item">
                    <div class="stat-dot supported"></div>
                    <span>Supported: <strong id="supportedCount">0</strong></span>
                </div>
                <div class="stat-item">
                    <div class="stat-dot uncertain"></div>
                    <span>Uncertain: <strong id="uncertainCount">0</strong></span>
                </div>
                <div class="stat-item">
                    <div class="stat-dot contradicted"></div>
                    <span>Contradicted: <strong id="contradictedCount">0</strong></span>
                </div>
            </div>
            <div class="factcheck-scroll" id="factcheckScroll">
                <div class="no-data">No fact-checks yet. Click Start to begin.</div>
            </div>
        </div>

        <!-- Episode Info -->
        <div class="episode-container">
            <div class="episode-info">
                <div class="episode-title">
                    Episode <span class="episode-number" id="episodeNum">--</span> - "<span id="episodeName">Waiting...</span>"
                </div>
                <div class="episode-time" id="episodeTime">Time: 00:00</div>
            </div>
            <div class="waveform" id="waveform">
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://0.0.0.0:8000/api/stream';
        let pollingInterval = null;
        let isStreaming = false;
        let currentTopicId = null;
        let lastTopicCount = 0;
        let lastFactCount = 0;

        // Start stream
        async function startStream() {
            try {
                const response = await fetch(`${API_BASE}/start`, { method: 'POST' });
                const data = await response.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                isStreaming = true;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('waveform').classList.add('active');

                startPolling();
            } catch (error) {
                console.error('Failed to start stream:', error);
                alert('Failed to start stream. Is the backend running?');
            }
        }

        // Stop stream
        async function stopStream() {
            try {
                const response = await fetch(`${API_BASE}/stop`, { method: 'POST' });

                stopPolling();
                isStreaming = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('waveform').classList.remove('active');

                // Final fetch
                await fetchResults();
            } catch (error) {
                console.error('Failed to stop stream:', error);
            }
        }

        // Polling
        function startPolling() {
            fetchResults();
            pollingInterval = setInterval(fetchResults, 1000);
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        // Fetch results
        async function fetchResults() {
            try {
                const response = await fetch(`${API_BASE}/results`);
                const data = await response.json();

                updateUI(data);

                if (data.status === 'completed' && isStreaming) {
                    stopStream();
                }
            } catch (error) {
                console.error('Failed to fetch results:', error);
            }
        }

        // Update UI
        function updateUI(data) {
            // Episode info
            if (data.metadata) {
                const filename = data.metadata.filename || 'Unknown';
                const name = filename.replace('.wav', '').replace('.mp3', '');
                document.getElementById('episodeName').textContent = name;
                document.getElementById('episodeNum').textContent = '42';
            }

            // Progress
            if (data.progress !== undefined) {
                document.getElementById('progressFill').style.width = data.progress + '%';

                if (data.metadata && data.metadata.duration_seconds) {
                    const currentTime = (data.progress / 100) * data.metadata.duration_seconds;
                    document.getElementById('episodeTime').textContent = `Time: ${formatTime(currentTime)}`;
                }
            }

            // Timeline
            if (data.topics && data.topics.length > lastTopicCount) {
                updateTimeline(data.topics, data.topic_images);
                lastTopicCount = data.topics.length;
            }

            // Fact-checks
            if (data.fact_checks && data.fact_checks.length > lastFactCount) {
                updateFactChecks(data.fact_checks, data.fact_verdicts);
                lastFactCount = data.fact_checks.length;
            } else if (data.fact_verdicts) {
                // Update counts even if no new facts
                document.getElementById('supportedCount').textContent = data.fact_verdicts.SUPPORTED || 0;
                document.getElementById('uncertainCount').textContent = data.fact_verdicts.UNCERTAIN || 0;
                document.getElementById('contradictedCount').textContent = data.fact_verdicts.CONTRADICTED || 0;
            }
        }

        // Update timeline
        function updateTimeline(topics, topicImages) {
            const flow = document.getElementById('timelineFlow');
            flow.innerHTML = '';

            topics.forEach((topic, index) => {
                // Topic badge container
                const container = document.createElement('div');

                const badge = document.createElement('div');
                badge.className = 'topic-badge';
                if (index === topics.length - 1) {
                    badge.classList.add('active');
                    currentTopicId = topic.topic_id;

                    // Auto-select latest topic image
                    const img = topicImages?.find(img => img.topic_id === topic.topic_id);
                    if (img) {
                        showTopicImage(topic.topic, img.image_url);
                    }
                }
                badge.textContent = topic.topic;
                badge.onclick = () => selectTopic(topic, topicImages);

                const timestamp = document.createElement('div');
                timestamp.className = 'topic-timestamp';
                timestamp.textContent = formatTimestamp(topic.timestamp);

                container.appendChild(badge);
                container.appendChild(timestamp);
                flow.appendChild(container);

                // Arrow
                if (index < topics.length - 1) {
                    const arrow = document.createElement('div');
                    arrow.className = 'topic-arrow';
                    arrow.textContent = '→';
                    flow.appendChild(arrow);
                }
            });

            // Auto-scroll
            const scroll = document.querySelector('.timeline-scroll');
            scroll.scrollLeft = scroll.scrollWidth;
        }

        // Select topic
        function selectTopic(topic, topicImages) {
            currentTopicId = topic.topic_id;

            // Update badges
            document.querySelectorAll('.topic-badge').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            // Show image
            const img = topicImages?.find(img => img.topic_id === topic.topic_id);
            if (img && img.image_url) {
                showTopicImage(topic.topic, img.image_url);
            } else {
                hideTopicImage();
            }
        }

        // Show image
        function showTopicImage(topicName, imageUrl) {
            const img = document.getElementById('mediaImage');
            const placeholder = document.getElementById('mediaPlaceholder');
            const topicLabel = document.getElementById('mediaTopic');

            img.src = imageUrl;
            img.classList.add('visible');
            placeholder.style.display = 'none';
            topicLabel.textContent = topicName;
            topicLabel.style.display = 'block';
        }

        // Hide image
        function hideTopicImage() {
            const img = document.getElementById('mediaImage');
            const placeholder = document.getElementById('mediaPlaceholder');
            const topicLabel = document.getElementById('mediaTopic');

            img.classList.remove('visible');
            placeholder.style.display = 'block';
            topicLabel.style.display = 'none';
        }

        // Update fact-checks
        function updateFactChecks(facts, verdicts) {
            const scroll = document.getElementById('factcheckScroll');

            // Update stats
            if (verdicts) {
                document.getElementById('supportedCount').textContent = verdicts.SUPPORTED || 0;
                document.getElementById('uncertainCount').textContent = verdicts.UNCERTAIN || 0;
                document.getElementById('contradictedCount').textContent = verdicts.CONTRADICTED || 0;
            }

            // Clear and rebuild
            scroll.innerHTML = '';

            // Group by verdict
            const supported = facts.filter(f => f.verdict === 'SUPPORTED');
            const uncertain = facts.filter(f => f.verdict === 'UNCERTAIN');
            const contradicted = facts.filter(f => f.verdict === 'CONTRADICTED');

            // Render each group
            [...supported, ...uncertain, ...contradicted].forEach(fact => {
                const item = createFactItem(fact);
                scroll.appendChild(item);
            });

            // Auto-scroll
            scroll.scrollTop = scroll.scrollHeight;
        }

        // Create fact item
        function createFactItem(fact) {
            const item = document.createElement('div');
            item.className = `fact-item ${fact.verdict.toLowerCase()}`;

            // Header
            const header = document.createElement('div');
            header.className = 'fact-header';
            header.innerHTML = `
                <div class="verdict-dot ${fact.verdict.toLowerCase()}"></div>
                <div class="verdict-label">${fact.verdict.charAt(0) + fact.verdict.slice(1).toLowerCase()}</div>
            `;
            item.appendChild(header);

            // Claim
            const claim = document.createElement('div');
            claim.className = 'fact-claim';
            claim.textContent = `"${fact.claim}"`;
            item.appendChild(claim);

            // Timestamp (extract from fact timestamp if available)
            const ts = document.createElement('div');
            ts.className = 'fact-timestamp';
            ts.textContent = `[${formatTimestamp(fact.timestamp)}]`;
            item.appendChild(ts);

            // Source
            const source = document.createElement('div');
            source.className = 'fact-source';
            if (fact.evidence_sources && fact.evidence_sources.length > 0) {
                const links = fact.evidence_sources.slice(0, 2).map(url => {
                    try {
                        const domain = new URL(url).hostname.replace('www.', '');
                        return `<a href="${url}" target="_blank">${domain}</a>`;
                    } catch {
                        return '??';
                    }
                }).join(', ');
                source.innerHTML = `Source: ${links}`;
            } else {
                source.textContent = 'Source: ??';
            }
            item.appendChild(source);

            // Expand badge (if multiple previous facts)
            const prevCount = Math.floor(Math.random() * 3); // Placeholder
            if (prevCount > 0) {
                const expand = document.createElement('div');
                expand.className = 'fact-expand';
                expand.innerHTML = `<span class="expand-badge">see ${prevCount} previous claim${prevCount > 1 ? 's' : ''} <span class="expand-arrow">↗</span></span>`;
                item.appendChild(expand);
            }

            return item;
        }

        // Format timestamp
        function formatTimestamp(isoString) {
            if (!isoString) return '00:00';
            const date = new Date(isoString);
            const mins = String(date.getMinutes()).padStart(2, '0');
            const secs = String(date.getSeconds()).padStart(2, '0');
            return `${mins}:${secs}`;
        }

        // Format time
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // Initial load
        window.addEventListener('load', () => {
            fetchResults();
        });
    </script>
</body>
</html>
